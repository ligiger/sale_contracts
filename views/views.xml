<odoo>
  <data>
    <!-- explicit list view definition -->
    <record model="ir.ui.view" id="kontrakt_kontrakt_tree">
      <field name="name">Liste der Kontrakte</field>
      <field name="model">kontrakt.kontrakt</field>
      <field name="arch" type="xml">
        <tree>
          <field name="name"/>
          <field name="product_id"/>
          <field name="date_create"/>
          <field name="amount_ordered"/>
          <field name="state"/>
        </tree>
      </field>
    </record>

    <record model="ir.ui.view" id="kontrakt_abruf_tree">
      <field name="name">Liste der Abrufe</field>
      <field name="model">kontrakt.abruf</field>
      <field name="arch" type="xml">
        <tree create="false">
          <field name="name"/>
          <field name="kontrakt_product_id"/>
          <field name="parent_kontrakt"/>
          <field name="state"/>
        </tree>
      </field>
    </record>

    <record model="ir.ui.view" id="kontrakt_position_tree">
      <field name="name">Liste der Positionen</field>
      <field name="model">kontrakt.position</field>
      <field name="arch" type="xml">
        <tree create="false">
          <field name="name"/>
          <field name="abruf_product_id"/>
          <field name="delivery_date"/>
          <field name="amount_planned"/>
          <field name="amount_done"/>
          <field name="parent_abruf"/>
          <field name="state"/>
        </tree>
      </field>
    </record>
    
    <!-- Kontrakt Form -->
    <record id="kontrakt_kontrakt_form" model="ir.ui.view">
      <field name="name">kontrakt_form</field>
      <field name="model">kontrakt.kontrakt</field>
      <field name="arch" type="xml">
        <form string="Kontraktverwaltung">
          <header>
            <button name="confirm" string="Bestätigen" type="object" states="draft" class="btn-primary"/>
            <button name="done" string="Abschliessen" type="object" states="confirmed" class="btn-primary"/>
            <button name="edit" string="Auf ENTWURF setzen" type="object" states="confirmed" class="btn-primary"/>
            <field name="state" widget="statusbar" statusbar_visible="draft,confirmed,done,cancel"/>
          </header>
          <sheet>
            <h1><field name="name" attrs="{'readonly':[('state','!=','draft')]}"/></h1>
            <group>
              <group>
                <field name="date_create"/>
                <field name="created_by"/>
              </group>
              <group>
                <field name="date_accepted"/>
                <field name="accepted_by"/>
              </group>
            </group>
            <group>
              <field name="product_id" attrs="{'readonly':[('state','!=','draft')]}"/>
            </group>
            <group>
              <field name="amount_ordered" attrs="{'readonly':[('state','!=','draft')]}"/>
              <field name="amount_delivered"/>
            </group>
            <group>
              <field name="abrufe" string="Abrufe" 
              domain="[('kontrakt_product_id', '=', product_id),('parent_kontrakt', '=', id)]" 
              context="{'default_kontrakt_product_id': product_id, 'default_parent_kontrakt': id}" 
              widget="one2many"
              attrs="{'readonly':[('state','!=','draft')]}">
                <tree>
                  <field name="name" string="Abruf"/>
                  <field name="kontrakt_product_id"/>
                </tree>
              </field>
            </group>
          </sheet>
          <div class="oe_chatter">
            <field name="message_follower_ids" widget="mail_followers"/>
            <field name="activity_ids" widget="mail_activity"/>
            <field name="message_ids" widget="mail_thread"/>
          </div>
        </form>
      </field>
    </record>

    <!-- Abruf Form-->
    <record id="kontrakt_abruf_form" model="ir.ui.view">
      <field name="name">abruf_form</field>
      <field name="model">kontrakt.abruf</field>
      <field name="arch" type="xml">
        <form string="Abrufe" create="false">
          <header>
            <button name="confirm" string="Bestätigen" type="object" states="draft" class="btn-primary"/>
            <button name="done" string="Abschliessen" type="object" states="active" class="btn-primary"/>
            <button name="edit" string="Auf ENTWURF setzen" type="object" states="active" class="btn-primary"/>
            <field name="state" widget="statusbar" statusbar_visible="draft,active,done,cancel"/>
          </header>
          <sheet>
            <group>
              <field name="name" attrs="{'readonly':[('state','!=','draft')]}"/>
              <field name="create_date" attrs="{'readonly':[('state','!=','draft')]}"/>
              <field name="created_by"/>
            </group>
            <group>
              <field name="kontrakt_product_id" attrs="{'readonly':[('state','!=','draft')]}"/>
              <field name="parent_kontrakt" string="Kontrakt" attrs="{'readonly':[('state','!=','draft')]}"/>
            </group>
            <group>
              <field name="amount_ordered" attrs="{'readonly':[('state','!=','draft')]}"/>
              <field name="amount_delivered"/>
            </group>
            <group>
              <field name="positionen" string="Positionen" 
              domain="[('abruf_product_id', '=', kontrakt_product_id)]" 
              context="{'default_abruf_product_id': kontrakt_product_id, 'default_parent_abruf': id}" 
              widget="one2many"
              attrs="{'readonly':[('state','!=','draft')]}">
                <tree>
                  <field name="name"/>
                  <field name="delivery_date"/>
                  <field name="amount_planned"/>
                  <field name="amount_done"/>
                  <field name="state"/>
                </tree>
              </field>
            </group>
          </sheet>
          <div class="oe_chatter">
            <field name="message_follower_ids" widget="mail_followers"/>
            <field name="activity_ids" widget="mail_activity"/>
            <field name="message_ids" widget="mail_thread"/>
          </div>
        </form>
      </field>
    </record>

<!-- Position Form-->
    <record id="kontrakt_position_form" model="ir.ui.view">
      <field name="name">position_form</field>
      <field name="model">kontrakt.position</field>
      <field name="arch" type="xml">
        <form string="Positionen" create="false">
          <header>
            <button name="confirm" string="Bestätigen" type="object" states="draft" class="btn-primary"/>
            <button name="done" string="Abschliessen" type="object" states="active" class="btn-primary"/>
            <button name="edit" string="Auf ENTWURF setzen" type="object" states="active" class="btn-primary"/>
            <field name="state" widget="statusbar" statusbar_visible="draft,active,done,cancel"/>
          </header>
          <sheet>
            <h1><field name="name" attrs="{'readonly':[('state','!=','draft')]}"/></h1>
            <group >
              <field name="create_date"/>
              <field name="created_by"/>
            </group>
            <group>
              <field name="abruf_product_id" attrs="{'readonly':[('state','!=','draft')]}"/>
              <field name="parent_abruf" string="Abruf" attrs="{'readonly':[('state','!=','draft')]}"/>
            </group>
            <group>
              <field name="delivery_date" attrs="{'readonly':[('state','!=','draft')]}"/>
              <field name="amount_planned" attrs="{'readonly':[('state','!=','draft')]}"/>
              <field name="amount_done" attrs="{'readonly':[('state','=','done')]}"/>  
            </group>
          </sheet>
          <div class="oe_chatter">
            <field name="message_follower_ids" widget="mail_followers"/>
            <field name="activity_ids" widget="mail_activity"/>
            <field name="message_ids" widget="mail_thread"/>
          </div>
        </form>
      </field>
    </record>
    


    <!-- actions opening views on models -->
    
    <record model="ir.actions.act_window" id="kontrakt_kontrakt_action_window">
      <field name="name">Kontrakte</field>
      <field name="res_model">kontrakt.kontrakt</field>
      <field name="view_mode">tree,form</field>
    </record>

    <record model="ir.actions.act_window" id="kontrakt_abruf_action_window">
      <field name="name">Abrufe</field>
      <field name="res_model">kontrakt.abruf</field>
      <field name="view_mode">tree,form</field>
    </record>

    <record model="ir.actions.act_window" id="kontrakt_position_action_window">
      <field name="name">Positionen</field>
      <field name="res_model">kontrakt.position</field>
      <field name="view_mode">tree,form</field>
    </record>
    

    <!-- Top menu item -->
    
    <menuitem name="Kontraktverwaltung" id="kontrakt_kontrakt_menu_root"/>
    
    <!-- menu categories -->
    
    <menuitem name="Kontrakte" id="kontrakt_kontrakt_menu_1" parent="kontrakt_kontrakt_menu_root"/>
    
    <!-- actions -->
    
    <menuitem name="Kontrakte" id="kontrakt_kontrakt_kontrakte" parent="kontrakt_kontrakt_menu_1"
              action="kontrakt_kontrakt_action_window"/>
    <menuitem name="Abrufe" id="kontrakt_kontrakt_abrufe" parent="kontrakt_kontrakt_menu_1"
              action="kontrakt_abruf_action_window"/>
    <menuitem name="Positionen" id="kontrakt_kontrakt_positionen" parent="kontrakt_kontrakt_menu_1"
              action="kontrakt_position_action_window"/>

  <!-- inherited views-->

  <record model="ir.ui.view" id="stock_picking_form_inherited">
      <field name="name">mi_new_view</field>
      <field name="model">stock.picking</field>
      <field name="inherit_id" ref="stock.view_picking_form"/>
      <!--<field name="mode">primary</field>-->
      <field name="priority" eval="15"/>
      <field name="arch" type="xml">
        <xpath expr="//field[@name='origin']" position="after">
          <field  name="geag_kontrakt" domain="[('state','=','confirmed')]" attrs="{'invisible': [('picking_type_code', '!=', 'outgoing')]}"/>
          <field  name="geag_abruf" domain="[('parent_kontrakt', '=', geag_kontrakt),('state','=','confirmed')]" attrs="{'invisible': [('picking_type_code', '!=', 'outgoing')]}"/>
          <field  name="geag_position" domain="[('parent_abruf', '=', geag_abruf),('state','=','confirmed')]" attrs="{'invisible': [('picking_type_code', '!=', 'outgoing')]}"/>
          <field  name="geag_delivery_date" attrs="{'invisible': [('picking_type_code', '!=', 'outgoing')]}"/>
        </xpath>
      </field>
  </record>

  </data>
</odoo>